!function(a,b){if("function"==typeof define&&define.amd)define(["localforage","backbone","underscore"],b);else if("undefined"!=typeof module&&module.exports){var c=require("localforage"),d=require("backbone"),e=require("underscore");module.exports=b(c,d,e)}else b(a.localforage,a.Backbone,a._)}(this,function(a,b,c){function d(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function e(){return d()+d()+"-"+d()+"-"+d()+"-"+d()+"-"+d()+d()+d()}function f(a,b,c,d){switch(b){case"read":return c.id?a.find(c,d):a.findAll(d);case"create":return a.create(c,d);case"update":return a.update(c,d);case"delete":return a.destroy(c,d)}}var g=window.Promise,h=function(a){this.data=null,this.name=a};return c.extend(h.prototype,{save:function(b){var c=this;return new g(function(d){a.setItem(c.name,JSON.stringify(c.data),function(a){b&&b(a),d(a)})})},create:function(b,c){var d=this;return new g(function(f){d.data?(b.id||(b.id=b.attributes.id=e()),d.data[b.id]=b.toJSON(),d.save(function(){c.success&&c.success(d.data[b.id]),f(d.data[b.id])})):a.getItem(d.name,function(a){d.data=JSON.parse(a)||{},b.id||(b.id=b.attributes.id=e()),d.data[b.id]=b.toJSON(),d.save(function(){c.success&&c.success(d.data[b.id]),f(d.data[b.id])})})})},update:function(b,c){var d=this;return new g(function(e){d.data?(d.data[b.id]=b.toJSON(),d.save(function(){c.success&&c.success(d.data[b.id]),e(d.data[b.id])})):a.getItem(d.name,function(a){d.data=JSON.parse(a)||{},d.data[b.id]=b.toJSON(),d.save(function(){c.success&&c.success(d.data[b.id]),e(d.data[b.id])})})})},find:function(b,c){var d=this;return new g(function(e){d.data?(c.success&&c.success(d.data[b.id]),e(d.data[b.id])):a.getItem(d.name,function(a){d.data=JSON.parse(a)||{},c.success&&c.success(d.data[b.id]),e(d.data[b.id])})})},findAll:function(b){var d=this;return new g(function(e){d.data?(b.success&&b.success(c.values(d.data)),e(c.values(d.data))):a.getItem(d.name,function(a){d.data=JSON.parse(a)||{},b.success&&b.success(c.values(d.data)),e(c.values(d.data))})})},destroy:function(b,c){var d=this;return new g(function(e){d.data?(delete d.data[b.id],d.save(function(){c.success&&c.success(b),e(b)})):a.getItem(__this.name,function(a){d.data=JSON.parse(a)||{},delete d.data[b.id],d.save(function(){c.success&&c.success(b),e(b)})})})}}),b.localforage={OfflineStore:h,sync:function(a){var c,d;return a?(c=new h(a),d=function(){return f.apply(null,[c].concat([].slice.call(arguments,0)))},d.offlineStore=c):d=function(a,c){var d=c.collection&&c.collection.sync.offlineStore;return d?f.apply(null,[d].concat([].slice.call(arguments,0))):b.sync.apply(this,arguments)},d}},b.localforage});