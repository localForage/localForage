(function(){function a(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function b(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}function c(a,b,c,d){switch(b){case"read":return c.id?a.find(c,d):a.findAll(d);case"create":return a.create(c,d);case"update":return a.update(c,d);case"delete":return a.destroy(c,d)}}var d=window.Promise,e=function(a){this.data=null,this.name=a};return _.extend(e.prototype,{save:function(a){var b=this;return new d(function(c){localforage.setItem(b.name,JSON.stringify(b.data),function(b){a&&a(b),c(b)})})},create:function(a,c){var e=this;return new d(function(d){e.data?(a.id||(a.id=a.attributes.id=b()),e.data[a.id]=a.toJSON(),e.save(function(){c.success&&c.success(e.data[a.id]),d(e.data[a.id])})):localforage.getItem(e.name,function(f){e.data=JSON.parse(f)||{},a.id||(a.id=a.attributes.id=b()),e.data[a.id]=a.toJSON(),e.save(function(){c.success&&c.success(e.data[a.id]),d(e.data[a.id])})})})},update:function(a,b){var c=this;return new d(function(d){c.data?(c.data[a.id]=a.toJSON(),c.save(function(){b.success&&b.success(c.data[a.id]),d(c.data[a.id])})):localforage.getItem(c.name,function(e){c.data=JSON.parse(e)||{},c.data[a.id]=a.toJSON(),c.save(function(){b.success&&b.success(c.data[a.id]),d(c.data[a.id])})})})},find:function(a,b){var c=this;return new d(function(d){c.data?(b.success&&b.success(c.data[a.id]),d(c.data[a.id])):localforage.getItem(c.name,function(e){c.data=JSON.parse(e)||{},b.success&&b.success(c.data[a.id]),d(c.data[a.id])})})},findAll:function(a){var b=this;return new d(function(c){b.data?(a.success&&a.success(_.values(b.data)),c(_.values(b.data))):localforage.getItem(b.name,function(d){b.data=JSON.parse(d)||{},a.success&&a.success(_.values(b.data)),c(_.values(b.data))})})},destroy:function(a,b){var c=this;return new d(function(d){c.data?(delete c.data[a.id],c.save(function(){b.success&&b.success(a),d(a)})):localforage.getItem(__this.name,function(e){c.data=JSON.parse(e)||{},delete c.data[a.id],c.save(function(){b.success&&b.success(a),d(a)})})})}}),Backbone.localforage={OfflineStore:e,sync:function(a){var b,d;return a?(b=new e(a),d=function(){return c.apply(null,[b].concat([].slice.call(arguments,0)))},d.offlineStore=b):d=function(a,b){var d=b.collection&&b.collection.sync.offlineStore;return d?c.apply(null,[d].concat([].slice.call(arguments,0))):Backbone.sync.apply(this,arguments)},d}},e}).call(this);